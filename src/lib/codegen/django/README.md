# Django Migration Generator

This module generates Django migration files from database diagrams created in the application using raw SQL operations.

## Features

- **SQL-Based Migrations**: Uses raw SQL for precise database schema control
- **Database Support**: Works with both MySQL and PostgreSQL databases with proper syntax
- **Table Ordering**: Respects table dependencies and creation order
- **Reversible Operations**: All migrations include proper reverse SQL statements
- **Complete Schema**: Includes tables, indexes, constraints, and custom types (PostgreSQL enums)
- **Separate Files**: Each table gets its own migration file for better organization

## Usage

```typescript
import { generateDjangoMigration, generateDjangoMigrationString } from './migration-generator';

// Generate migration files
const migrationFiles = generateDjangoMigration(diagram, {
  timestamp: '20250109120200' // Optional custom timestamp
});

// Generate formatted string output
const output = generateDjangoMigrationString(diagram, options);
```

## Migration Structure

Each generated migration uses raw SQL operations:

```python
from django.db import migrations

class Migration(migrations.Migration):
    initial = True
    
    dependencies = []
    
    operations = [
        migrations.RunSQL(
            "CREATE TABLE `table_name` (...)",
            reverse_sql="DROP TABLE `table_name`"
        ),
    ]
```

## Generated Files

The generator creates separate migration files:

1. **Table Creation**: One file per table (e.g., `20250109120200_create_users_table.py`)
2. **Foreign Keys**: Separate file for all foreign key constraints (e.g., `20250109120203_add_foreign_key_constraints.py`)
3. **Indexes**: Included in table creation migrations
4. **Custom Types**: PostgreSQL enums are created before tables that use them

## Configuration Options

### DjangoMigrationOptions

- `timestamp`: Custom timestamp for migration files (default: auto-generated)

The generator automatically detects the database type from the diagram and generates appropriate SQL syntax.

## SQL Generation

The generator uses the same SQL generation engine as other export formats, ensuring consistency and accuracy:

### MySQL Features
- Proper backtick quoting for identifiers
- AUTO_INCREMENT for primary keys
- MySQL-specific data types and syntax
- SET and ENUM types

### PostgreSQL Features
- Double-quote quoting for identifiers
- GENERATED BY DEFAULT AS IDENTITY for auto-increment
- Custom ENUM types with CREATE TYPE statements
- JSONB support
- Column comments

## Migration Operations

All migrations use `migrations.RunSQL()` with proper reverse operations:

- **CREATE TABLE**: Reversed with DROP TABLE
- **CREATE TYPE**: Reversed with DROP TYPE IF EXISTS
- **CREATE INDEX**: Reversed with DROP INDEX
- **ALTER TABLE ADD CONSTRAINT**: Reversed with DROP CONSTRAINT/DROP FOREIGN KEY
- **COMMENT ON COLUMN**: Reversed with COMMENT ... IS NULL

## Installation in Django Project

1. **Create Django Apps**:
   ```bash
   python manage.py startapp myapp
   ```

2. **Copy Generated Content**:
   - Copy models.py content to your app's models.py
   - Copy migration files to app's migrations/ directory

3. **Update Settings**:
   ```python
   # settings.py
   INSTALLED_APPS = [
       'myapp',
       # ... other apps
   ]
   ```

4. **Run Migrations**:
   ```bash
   python manage.py migrate
   ```

## Error Handling

The generator validates:
- Circular foreign key dependencies
- Reserved Django field names
- Missing primary keys
- Invalid field type mappings

## Best Practices

1. **Review Generated Code**: Always review generated migrations before applying
2. **Test Migrations**: Run migrations in a development environment first
3. **Backup Data**: Always backup your database before running migrations
4. **Custom Fields**: Modify generated code for custom field requirements
5. **Relationships**: Verify foreign key relationships match your intended design